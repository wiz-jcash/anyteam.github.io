# invoice

Модель **invoice** предназначена для выставления счетов клиентам и пополнения мерчантом своих балансов собственными средствами.

Выбор способа оплаты совершается клиентом в рамках заданных мерчантом платежных систем.

Параметр **is\_multipay** определяет критерий зачисления средств мерчанту:

* **is\_multipay = true** -  зачисление средств на баланс мерчанта производится только при накоплении оплат в размере 

  суммы, что указана в выставленном счете.

  > Если сумма базового платежа меньше выставленной в счете, то клиент может выполнить доплату или вернуть себе уже перечисленные средства. А в случае переплаты - получить обратно сдачу.

* **is\_multipay = false** - не предусмотрена возможность доплаты или возврата. Сумма платежа сразу и в полном объеме, за 

  вычетом комиссии, зачисляется на баланс мерчанта.

**Доля** общей суммы комиссии за поступления, которую оплачивает мерчант, определяется значением параметра **merchant\_payfee** \[0..1\], остаток комиссии платят клиенты. А операционные расходы по возврату средств **всегда** несут клиенты.

Используя методы модели **invoice** мерчант может:

1. Создать счет на оплату методом [invoice.create](invoice.md#invoice_create);  
2. Рассчитать предварительные параметры счета - метод 

   [invoice.calc](invoice.md#invoice_calc);  

3. Получить информацию по выбранному счету - метод 

   [invoice.get](invoice.md#invoice_get).  

## endpoint

Запросы на работу методов модели отправляются на endpoint **`https://api.any.money/`**.

## invoice.create

Метод создания ордера входящего платежа, учитывающего суммы счета и оплаты.

??? abstract "Входящие параметры метода создания ордера invoice-платежа"

| param | required | example | description |
| ---: | :---: | :--- | :--- |
| amount | yes | "1000,25" | сумма invoice-платежа |
| callback\_url | no | "[https://callback\_example.com](https://callback_example.com)" | url-адрес для уведомлений про изменения состояния ордера, [формат уведомлений](add_order.md#order_repr) |
| client\_email | no | "customer@domain.com" | email-адрес плательщика для нотификаций про изменения состояния invoice-платежа |
| externalid | yes | "123" | уникальный идентификатор, заданный мерчантом |
| in\_curr | yes | "UAH" | валюта пополнения invoice-платежа |
| is\_multipay | no | false | флаг, обеспечивающий возможность совершения доплаты и получения возврата \(true = доплата и возврат возможны, false = блокированы\). default=false |
| lifetime | no | "1d12h" | "время жизни" ордера, в секундах или в формате **timedelta** \(строка формата "1w1d1h1m1s1ms"\). Допустимый диапазон значений: "7d".."3600s". default="7d" |
| merchant\_payfee | no | "0,35" | **доля** общей суммы комиссии за поступления, которую оплачивает мерчант \(значение в интервале \[0..1\] c точностью до двух знаков после запятой. 0=0%..1=100%\) |
| out\_curr | no | "USD" | опциональная валюта зачисления invoice-платежа |
| payway | no | "card" | платежная система, через которую проводится пополнение \(возможные варианты: "btc", "perfect", "qiwi"... и т.д.\). Для мерчанта, имеющего привязку к ПС, доступна только ПС привязки |
| redirect\_url | no | "[https://example.com/order\_page/](https://example.com/order_page/)" | url-адрес для перенаправления пользователя после завершения работы или нажатия им кнопки "Назад" |

!!! warning "Внимание!" Если в метод передаётся наименование платёжной системы, то **обязательно** с ним нужно передать приведенные ниже параметры соответствующей платёжной системы:

??? info "Обязательные параметры для используемых в методе платёжных систем"  **qiwi** **exmo, kuna, anycash** &lt;/dd&gt;

Если передано наименование валюты зачисления \(**out\_curr**\), отличное от имени валюты пополнения \(**in\_curr**\), то после удачной финализации ордера будет выполнена попытка конвертировать поступившую сумму в валюту зачисления по текущему курсу. При удачной попытке средства будут зачислены на баланс валюты зачисления, иначе - на баланс валюты пополнения.  
Если переданное наименование валюты зачисления равно наименованию валюты пополнения, то метод **invoice.create** в своей работе проигнорирует значение параметра **out\_curr**.  
Если в запросе не передано значение **out\_curr**, то будет произведено зачисление на баланс валюты с именем **in\_curr**.  
Значения **timedelta** передаются в формате пар: &lt;значение&gt;&lt;ключ&gt;&lt;значение&gt;&lt;ключ&gt;…&lt;значение&gt;&lt;ключ&gt; **без пробелов** между парами. Возможна передача **только** секунд в виде значения без ключа. Но, если в строке **timedelta** применён хоть один ключ, то она обязана завершаться ключом, а не цифрой, иначе будет возвращена ошибка.

!!! warning "Внимание!" Для типизированных мерчантов передаваемая платежная система **должна** совпадать с типом мерчанта, иначе метод возвратит ошибку

!!! success "Данные ответа метода" [репрезентация ордера](add_order.md) входящего платежа

??? failure "Возможные возвращаемые ошибки" **EParamAmountFormatInvalid**неправильный формат параметра \*\*amount\*\***EParamAmountTooBig**\*\*amount\*\* больше максимальной суммы операции**EParamAmountTooSmall**\*\*amount\*\* меньше минимальной суммы операции**EParamCurrencyInvalid**валюта отсутствует в системе**EParamFieldInvalid**передан невалидный параметр \*\*callback\_url\*\***EParamInvalid**

## invoice.calc

Метод расчета параметров входящего invoice-платежа с учётом суммы зачисления.

??? abstract "Входящие параметры расчета ордера invoice-платежа"

| param | required | example | description |
| ---: | :---: | :--- | :--- |
| amount | yes | "500" | сумма входящего платежа |
| in\_curr | yes | "USD" | валюта пополнения, т.е. валюта поступления средств в систему |
| payway | yes | "anycash" | платежная система, через которую ожидается пополнение |

!!! warning "Внимание!" Для типизированных мерчантов передаваемая платежная система должна совпадать с типом мерчанта, иначе метод возвратит ошибку

!!! success "Данные ответа метода" **account\_amount**сумма зачисления, за вычетом комиссии**in\_amount**сумма пополнения**orig\_amount**сумма, задаваемая при создании ордера**out\_amount**сумма зачисления на баланс мерчанта**rate**курс конвертации входящей в исходящую валюты, если проводилась конвертация

??? failure "Возможные возвращаемые ошибки" **EParamAmountFormatInvalid**неправильный формат параметра \*\*amount\*\***EParamAmountTooBig**\*\*amount\*\* больше максимальной суммы операции**EParamAmountTooSmall**\*\*amount\*\* меньше минимальной суммы операции**EParamCurrencyInvalid**валюта отсутствует в системе**EParamInvalid**

## invoice.get

Метод для запроса параметров **invoice**-платежа по его внешнему идентификатору.

??? abstract "Входящие параметры запроса данных invoice-платежа"

| param | required | example | description |
| ---: | :---: | :--- | :--- |
| externalid | yes | "257" | уникальный идентификатор платежа, заданный мерчантом |

!!! success "Данные ответа метода" [репрезентация ордера](add_order.md) операции входящего платежа

??? failure "Возможные возвращаемые ошибки" **EParamInvalid**\*\*externalid\*\* передан пустой, неправильного типа или имеет недопустимое значение**EParamNotFound**не найден ордер c переданным \*\*externalid\*\*

